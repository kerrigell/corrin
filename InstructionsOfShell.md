#operating instructions for command shell

### 启动 ###
在完成数据库连接配置后，即可通过python调用dbpizza.py的方式启动程序。
在没有进行二进制包安装前，可以通过在 .bash\_profile创建别名的方式进行快速启动
```
alias dbpizza='python /root/git/dbpizza/dbpizza.py'
```
启动完成时，程序处于中央节点
```
Pizza [cn:common:10.12.2.37[001:中央节点中控-37]]>
```
### 节点信息 ###
如上方启动时显示的 **cn:common:10.12.2.37[001:中央节点中控-37]** 称为节点信息，是识别每个服务器节点的字符串信息，此信息除用作识别外，还会作为参数传递给一些命令使用，具体使用方法请参照具体命令。

每个节点信息由5部分组成，分别是：地区域名、产品名称、IP地址、节点记录ID、描述。

组成形式：
  * 信息间使用英文冒号间隔
  * 数据记录ID和描述使用"["和"]"组合在一起
  * 组成格式如下
```
  域名:产品:IP地址[节点记录ID:描述]
```

### 操作命令 ###
#### 命令帮助 ####
此工具中的所有命令均可以使用 -h 参数打印命令的帮助信息。

其中有一些参数，是大多数命令均支持的，称之为通用参数。通过这些参数可以实现对多台服务器进行相同操作。

以下为通用参数列表：

| **长参数** | **短参数** | **值** | **作用** |
|:--------------|:--------------|:--------|:-----------|
| --piece= | -p | piece名称 |  piece名称，使用piece命令创建 |
| --childs | -c |  | 启用子节点队列，使用后会将所有子节点加入到执行队列 |
| --recursion |  |  | 配合--childs命令使用，表示递归子节点，使用将会把当前节点的所有下级节点添加到执行队列 |

#### cd ####
cd命令用于节点之间跳转，此处借用操作系统的cd命令的理念。目前可使用三种方式：
| **命令**    | **说明**               |
|:--------------|:-------------------------|
|cd ..      |跳转到上层节点 |
|cd ~       |跳转到中央节点 |
|cd us:nagios:127.13.51.7[045:北美卫星监控机-7]  |跳转到指定节点  |
|cd us[[.md](.md)Tab[.md](.md)]       |使用Tab键会写出所有与数据字符匹配的下级节点列表  |

#### piece ####
piece命令用于创建一个符合条件的服务器节点组，此组名称可以传递给其他命令的--piece=参数，实现同时对多台机器进行操作。

参数列表：
| **长参数** | **短参数** | **值** | **作用** |
|:--------------|:--------------|:--------|:-----------|
| --create | -c |  |  启动创建piece动作 |
| --name= | -n | piece名称（字符串） | 指定piece名称 |
| --ploy= | -p | 筛选字符串 | 指定筛选字符串 |
| --list | -l |  | 列出已存在piece列表 |

  * **创建piece**
    * 需要同时指定 --create / --name= / --ploy= 参数
    * --ploy参数值是逗号间隔的字符串，筛选值是数据表 t\_server 字段region、product、role的值
```
Pizza [cn:common:10.12.2.37[001:中央节点中控-37]]>piece -c --name=test -p my,sdo
my:sdo:13.21.100.204[217:Test1]
my:sdo:13.21.100.52[219:Group1]
my:sdo:13.21.100.57[220:Group2]
my:sdo:13.21.100.15[244:Test2]
```
  * **显示已存在piece**
    * 启动--list参数，将显示已存在的piece名列表
    * 指定了--name=参数，将显示此piece的节点信息
```
Pizza [cn:common:10.12.2.37[001:中央节点中控-37]]>piece -l
test
Pizza [cn:common:10.12.2.37[001:中央节点中控-37]]>piece -l -n test
test
     CreateTime: Tue Dec  3 15:25:41 2013
     my:sdo:13.21.100.204[217:Test1]
     my:sdo:13.21.100.52[219:Group1]
     my:sdo:13.21.100.57[220:Group2]
     my:sdo:13.21.100.15[244:Test2]
```
#### trans ####
trans命令，用于将 **当前节点** 指定文件或文件夹传送到服务器队列中的所有节点。此命令只做一对多的扇出拷贝操作，不提供多对多的操作。目标节点可以是节点网络上任意节点。

此命令基于底层Transfer类实现，也是实现复杂业务逻辑的一个重要操作类。

参数列表：
| **长参数** | **短参数** | **值** | **作用** |
|:--------------|:--------------|:--------|:-----------|
| --piece= | -p | piece名称 |  piece名称，使用piece命令创建 |
| --childs | -c |  | 启用子节点队列，使用后会将所有子节点加入到执行队列 |
| --recursion |  |  | 配合--childs命令使用，表示递归子节点，使用将会把当前节点的所有下级节点添加到执行队列 |
| --target= | -t | 文件路径 | 当前节点服务器待传输文件路径 |
| --deploy\_dir= | -d | 目录路径 | 目标服务器的保存路径 |
| --who= | -w | 单个节点名称 | 指定单个目标节点 |

#### cmd ####
cmd命令，用于在目标节点执行命令。

被执行的命令要使用英文双引号进行间隔，支持多个命令，只要分别使用"间隔即可。命令输出将打印到节点信息下。
```
Pizza [cn:common:10.12.2.37[001:中央节点中控-37]]>cmd "netstat -ant | grep 3306" "ifconfig | egrep -i eth0 "
Server Count:1
cn:common:10.12.2.37[001:中央节点中控-37]
tcp        0      0 127.0.0.1:59273             127.0.0.1:3306              TIME_WAIT   
tcp        1      0 127.0.0.1:32952             127.0.0.1:3306              CLOSE_WAIT  
tcp        1      0 127.0.0.1:33081             127.0.0.1:3306              CLOSE_WAIT  
tcp        0      0 220.181.143.248:33064       54.251.134.169:22           ESTABLISHED 
tcp        0      0 :::3306                     :::*                        LISTEN      
tcp        0      0 ::ffff:10.127.64.248:3306   ::ffff:10.6.48.122:59167    ESTABLISHED 
eth0      Link encap:Ethernet  HWaddr 00:0C:29:2E:58:CD
```

参数列表：
| **长参数** | **短参数** | **值** | **作用** |
|:--------------|:--------------|:--------|:-----------|
| --piece= | -p | piece名称 |  piece名称，使用piece命令创建 |
| --childs | -c |  | 启用子节点队列，使用后会将所有子节点加入到执行队列 |
| --recursion |  |  | 配合--childs命令使用，表示递归子节点，使用将会把当前节点的所有下级节点添加到执行队列 |

#### login ####
login命令，用于创建一个与目标节点服务器交互的ssh session。此命令不支持通用参数。
```
Pizza [cn:common:10.12.2.37[001:中央节点中控-37]]>cd my:common:13.20.122.14[023:马来地区中控]
Pizza [my:common:13.20.122.14[023:马来地区中控]]>login
Last login: Tue Dec  3 16:41:44 2013 from 34.18.103.37

****************************************
** HOST: my_cc_122.14
** IDC:  my 
** IP:   10.56.122.14\ 13.20.122.14
****************************************

[root@my_cc_122.14 ~]# 
```
**标注** : 由于对底层Fabric模块使用参数不熟悉，创建的session中vi只支持原生光标移动快捷键，不能使用方向键对光标进行操作，需要进一步改进。

#### ipsec ####
ipsec命令，用于管理操作系统的防火墙。
  * **设计思路**
    * 将防火墙INPUT 和OUTPU筛选器存入数据库表，利用统一预设模板生成加载脚本，刷新系统内防火墙。
    * 筛选器存入数据库前要求提供对应说明，可以保障日后其他人员识别和调整
  * 参数列表
| **长参数** | **短参数** | **值** | **作用** |
|:--------------|:--------------|:--------|:-----------|
| --add | -a |  |  启动添加策动作 |
| --chain= |  | INPUT OUTPUT FORWARD | 可选参数，给出筛选链名称，默认为INPUT |
| --source= |  | 访问源地址 | 访问源地址 |
| --protocal= |  | tcp  udp  imcp  all | 通讯协议 |
| --dport= |  | 端口号 | 端口号列表，使用逗号进行间隔 |
| --delete | -d |  | 删除数据库中的策略 |
| --list | -l |  | 显示目前节点的策略记录 |
| --script |  |  | 显示依据数据库策略自动生成的iptables脚本 |
| --status |  |  | 打印目标服务器当前防火墙状态，内部通过执行 iptables -nvL 实现|
| --reload |  |   |将数据库中的策略刷新到服务器上 |
    * 使用示例
      1. 添加策略
> > > > 格式： ipsec --add [--chain=INPUT] --source=XXX.XXX.XXX.XXX/YY --dport=XXXX,XX --protocal=tcp | udp | icmp | all  descriptions like this


#### mysql ####

#### nagios ####

#### sysinit ####

#### sysinfo ####

#### crontab ####